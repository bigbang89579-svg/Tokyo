<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026 Â· æš–è‰²è¡Œç¨‹è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #fff7e8;
      --bg-card: #fffaf0;
      --bg-day: #e9f6ff;
      --orange-main: #ffb84d;
      --orange-soft: #ffe2ad;
      --brown-main: #62401f;
      --brown-soft: #9c7350;
      --border-soft: #f2d6aa;
      --shadow-soft: 0 2px 4px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: var(--bg-main);
      color: var(--brown-main);
    }

    header {
      background: #ffe7c4;
      padding: 16px 16px 10px;
      border-radius: 0 0 24px 24px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 24px;
      letter-spacing: 0.05em;
    }
    header p {
      margin: 2px 0;
      font-size: 13px;
      line-height: 1.5;
    }
    .header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--orange-soft);
      color: var(--brown-main);
      box-shadow: var(--shadow-soft);
      white-space: nowrap;
    }
    .btn.primary {
      background: var(--orange-main);
      font-weight: 600;
    }
    .btn.danger {
      background: #ffd0c8;
      color: #b03a2e;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 11px;
      box-shadow: none;
    }

    /* Day Nav */
    .day-nav-wrap {
      background: var(--bg-day);
      padding: 8px 0 10px;
    }
    .day-nav-row {
      display: flex;
      gap: 8px;
      padding: 0 10px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    .day-chip {
      flex: 0 0 auto;
      min-width: 80px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fff;
      box-shadow: var(--shadow-soft);
      text-align: center;
      cursor: grab;
      user-select: none;
    }
    .day-chip.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .day-chip-main {
      display: block;
      font-weight: 700;
      font-size: 14px;
    }
    .day-chip-sub {
      display: block;
      font-size: 11px;
      color: var(--brown-soft);
      margin-top: 2px;
    }

    /* Content */
    .page {
      padding: 8px 10px 80px;
    }
    .day-section {
      background: #f3fbff;
      border-radius: 20px;
      padding: 10px 10px 12px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-soft);
    }
    .day-title {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      background: #ffffff;
      border-radius: 999px;
      padding: 6px 10px;
      margin-bottom: 8px;
      font-size: 15px;
    }
    .day-title-main {
      font-weight: 700;
    }
    .day-title-date {
      font-size: 13px;
      color: var(--brown-soft);
    }

    .day-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* è¡Œç¨‹å¡ç‰‡ */
    .spot-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 8px 10px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f8ebd7;
      cursor: grab;
    }
    .spot-card.dragging {
      opacity: 0.6;
    }
    .spot-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 4px;
    }
    .spot-name-zh {
      font-weight: 700;
      font-size: 15px;
    }
    .spot-name-ja {
      font-size: 13px;
      color: var(--brown-soft);
      margin-top: 2px;
    }
    .spot-meta {
      font-size: 12px;
      color: var(--brown-soft);
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .image-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .spot-photo {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }
    .drag-hint {
      font-size: 11px;
      color: var(--brown-soft);
      margin-top: 4px;
    }

    /* æ–°å¢è¡Œç¨‹å¡ç‰‡ */
    .add-spot-card {
      background: #fffef8;
      border-radius: 16px;
      padding: 8px 10px 9px;
      border: 1px dashed var(--border-soft);
      box-shadow: var(--shadow-soft);
      font-size: 13px;
    }
    .add-spot-title {
      font-weight: 700;
      margin-bottom: 6px;
    }
    .add-spot-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .add-spot-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #e5d1a8;
      padding: 6px 9px;
      font-size: 13px;
    }

    /* ç•¶æ—¥å‚™è¨» */
    .day-note-block {
      background: #fffaf0;
      border-radius: 16px;
      padding: 8px 10px 10px;
      border: 1px solid #f3dfbd;
      box-shadow: var(--shadow-soft);
      margin-top: 2px;
    }
    .day-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }
    .day-note-title {
      font-weight: 700;
      font-size: 14px;
    }
    .day-note-box {
      border-radius: 12px;
      border: 1px dashed var(--border-soft);
      padding: 8px;
      font-size: 13px;
      background: #fffdf7;
      min-height: 40px;
      line-height: 1.4;
    }

    /* editable */
    [contenteditable="true"] {
      outline: none;
    }
    [contenteditable="true"]:focus {
      outline: 1px solid #ffcf7a;
      background: #fff7e1;
      border-radius: 4px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px 10px 10px;
      background: #ffe7c4;
      display: flex;
      justify-content: flex-end;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
      z-index: 15;
    }
    footer .btn {
      min-width: 90px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="tripTitle" contenteditable="true">Niji Trip 2026 ğŸŒˆ</h1>
    <p id="tripDesc1" contenteditable="true">
      æ±äº¬è¡Œç¨‹ï¼æš–è‰²ä¸»é¡Œï¼è¡Œç¨‹æ¬„ä½å¯æ‹–æ‹‰æ’åºï¼Œå¤©æ•¸å¯æ‹–æ‹‰é‡æ’ï¼‹è‡ªå‹• Day ç·¨è™Ÿã€‚
    </p>
    <p id="tripDesc2" contenteditable="true">
      âœï¸ æ¯ä¸€å¤©çš„ã€Œç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ã€ç¶­æŒåœ¨æœ€ä¸‹æ–¹ï¼Œæ–‡å­—å¯ç·¨è¼¯ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ç…§ç‰‡ã€‚
    </p>
    <div class="header-row">
      <button class="btn" id="backupExportBtn">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
      <button class="btn" id="backupImportBtn">åŒ¯å…¥å‚™ä»½</button>
      <button class="btn primary" id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
      <button class="btn danger" id="removeLastDayBtn">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
    </div>
  </header>

  <div class="day-nav-wrap">
    <div class="day-nav-row" id="dayNavRow">
      <!-- ç”± JS ç”¢ç”Ÿ Day æ¨™ç±¤ -->
    </div>
  </div>

  <div class="page">
    <div id="content">
      <!-- ç”± JS ç”¢ç”Ÿæ¯æ—¥å€å¡Š -->
    </div>
  </div>

  <footer>
    <button class="btn" id="dummyBtn">å·²è‡ªå‹•å„²å­˜</button>
  </footer>

  <!-- éš±è— inputï¼šå‚™ä»½ & ç…§ç‰‡ -->
  <input type="file" id="backupImportFile" accept="application/json" style="display:none" />
  <input type="file" id="photoInput" accept="image/*" style="display:none" />

  <!-- ğŸ§¹ æ²’æœ‰ Service Workerï¼Œé¿å…å¡ä½èˆŠç‰ˆå¿«å– -->
  <script>
    const STORAGE_KEY = "nijiTrip2026_vFinal";
    const YEAR = 2026;

    const navRow = document.getElementById("dayNavRow");
    const content = document.getElementById("content");

    let currentPhotoTarget = null;

    /* å·¥å…·ï¼šæ ¼å¼åŒ–æ—¥æœŸ mm/dd */
    function formatDateShort(dateObj) {
      const m = dateObj.getMonth() + 1;
      const d = dateObj.getDate();
      return m + "/" + d;
    }

    /* å»ºç«‹ Day nav chip + section */
    function createDay(dayIndex, dateObj) {
      const dayId = "day-" + Date.now() + "-" + Math.random().toString(16).slice(2);

      // nav chip
      const chip = document.createElement("div");
      chip.className = "day-chip";
      chip.draggable = true;
      chip.dataset.dayId = dayId;
      chip.innerHTML = `
        <span class="day-chip-main" contenteditable="true">Day ${dayIndex}</span>
        <span class="day-chip-sub" contenteditable="true">${formatDateShort(dateObj)}</span>
      `;
      navRow.appendChild(chip);

      // section
      const sec = document.createElement("section");
      sec.className = "day-section";
      sec.dataset.dayId = dayId;
      sec.dataset.dateIso = dateObj.toISOString();

      const title = document.createElement("div");
      title.className = "day-title";
      title.innerHTML = `
        <span class="day-title-main" contenteditable="true">Day ${dayIndex}</span>
        <span>ï¼ˆ</span>
        <span class="day-title-date" contenteditable="true">${formatDateShort(dateObj)}</span>
        <span>ï¼‰</span>
      `;
      sec.appendChild(title);

      const body = document.createElement("div");
      body.className = "day-body";

      // ç¯„ä¾‹ä¸€å€‹è¡Œç¨‹å¡ï¼ˆå¯è‡ªè¡Œåˆªé™¤æˆ–å†æ–°å¢ï¼‰
      const spot = createSpotCard("ç¯„ä¾‹æ™¯é»", "æ—¥æ–‡åç¨±æˆ–åœ°å€");
      body.appendChild(spot);

      // æ–°å¢è¡Œç¨‹å¡ç‰‡æŒ‰éˆ•
      const addSpot = createAddSpotCard();
      body.appendChild(addSpot);

      // ç•¶æ—¥å‚™è¨»ï¼ˆæ°¸é åœ¨æœ€å¾Œï¼‰
      const note = createDayNoteBlock();
      body.appendChild(note);

      sec.appendChild(body);
      content.appendChild(sec);
    }

    /* å»ºç«‹è¡Œç¨‹å¡ç‰‡ */
    function createSpotCard(nameZh, nameJa) {
      const card = document.createElement("div");
      card.className = "spot-card";
      card.draggable = true;
      card.innerHTML = `
        <div class="spot-header">
          <div>
            <div class="spot-name-zh" contenteditable="true">${nameZh || "æ™¯é»åç¨±"}</div>
            <div class="spot-name-ja" contenteditable="true">${nameJa || "æ—¥æ–‡åç¨±æˆ–åœ°å€"}</div>
            <div class="spot-meta" contenteditable="true">åœ°å€ãƒ»ç°¡çŸ­èªªæ˜å¯å¯«åœ¨é€™è£¡</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn small btn-dir">å¾é£¯åº—å°èˆª</button>
          <button class="btn small btn-search">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
          <button class="btn small btn-map">åœ°åœ–é è¦½</button>
          <button class="btn small btn-photo">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="drag-hint">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>
        <div class="image-list"></div>
      `;
      return card;
    }

    /* æ–°å¢è¡Œç¨‹å¡ç‰‡å€å¡Š */
    function createAddSpotCard() {
      const card = document.createElement("div");
      card.className = "add-spot-card";
      card.innerHTML = `
        <div class="add-spot-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
        <div class="add-spot-row">
          <input type="text" class="input-spot-zh" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
          <input type="text" class="input-spot-ja" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        </div>
        <button class="btn primary btn-add-spot">æ–°å¢</button>
      `;
      return card;
    }

    /* ç•¶æ—¥å‚™è¨»å€å¡Šï¼ˆå›ºå®šåœ¨æ¯å¤©æœ€ä¸‹æ–¹ï¼‰ */
    function createDayNoteBlock() {
      const card = document.createElement("div");
      card.className = "day-note-block";
      card.innerHTML = `
        <div class="day-note-header">
          <span class="day-note-title" contenteditable="true">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</span>
          <button class="btn small btn-daynote-photo">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="day-note-box" contenteditable="true">
ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦
        </div>
        <div class="image-list"></div>
      `;
      return card;
    }

    /* ç¶å®šæ‰€æœ‰äº‹ä»¶ */
    function bindAllEvents(root = document) {
      // æ‰€æœ‰å¯ç·¨è¼¯æ¬„ä½ â†’ è‡ªå‹•å„²å­˜
      root.querySelectorAll("[contenteditable='true']").forEach(el => {
        el.removeEventListener("input", onEditableInput);
        el.addEventListener("input", onEditableInput);
      });

      attachNavDragEvents();
      attachSpotDragEvents();
      attachAddSpotEvents();
      attachPhotoEvents();
      attachNotePhotoEvents();
      attachHeaderButtons();
    }

    function onEditableInput() {
      scheduleSave();
    }

    /* Day nav æ‹–æ‹‰é‡æ’ */
    let draggingDayId = null;
    function attachNavDragEvents() {
      const chips = navRow.querySelectorAll(".day-chip");
      chips.forEach(chip => {
        chip.removeEventListener("dragstart", onDayChipDragStart);
        chip.removeEventListener("dragend", onDayChipDragEnd);
        chip.addEventListener("dragstart", onDayChipDragStart);
        chip.addEventListener("dragend", onDayChipDragEnd);
      });

      navRow.removeEventListener("dragover", onDayNavDragOver);
      navRow.removeEventListener("drop", onDayNavDrop);
      navRow.addEventListener("dragover", onDayNavDragOver);
      navRow.addEventListener("drop", onDayNavDrop);
    }

    function onDayChipDragStart(e) {
      draggingDayId = e.currentTarget.dataset.dayId;
      e.currentTarget.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }
    function onDayChipDragEnd(e) {
      e.currentTarget.classList.remove("dragging");
      draggingDayId = null;
      recalcDayNumbers();
      scheduleSave();
    }
    function onDayNavDragOver(e) {
      e.preventDefault();
      const draggingEl = navRow.querySelector(".day-chip.dragging");
      if (!draggingEl) return;
      const after = getHorizontalAfterElement(navRow, e.clientX);
      if (!after) {
        navRow.appendChild(draggingEl);
      } else {
        navRow.insertBefore(draggingEl, after);
      }
    }
    function onDayNavDrop(e) {
      e.preventDefault();
      if (!draggingDayId) return;
      // ä¾ nav é †åºé‡æ’ section
      const order = Array.from(navRow.children).map(chip => chip.dataset.dayId);
      const sections = Array.from(content.querySelectorAll(".day-section"));
      order.forEach(id => {
        const sec = sections.find(s => s.dataset.dayId === id);
        if (sec) content.appendChild(sec);
      });
      recalcDayNumbers();
      scheduleSave();
    }
    function getHorizontalAfterElement(container, x) {
      const els = [...container.querySelectorAll(".day-chip:not(.dragging)")];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    }

    /* é‡ç®— Day ç·¨è™Ÿï¼ˆä¾ nav é †åºï¼‰ */
   function recalcDayNumbers() {
  const chips = navRow.querySelectorAll(".day-chip");
  const sections = content.querySelectorAll(".day-section");

  chips.forEach((chip, idx) => {
    const num = idx + 1;
    const id = chip.dataset.dayId;

    // ä¸Šæ–¹ç™½è‰² Day æ¨™ç±¤
    const main = chip.querySelector(".day-chip-main");
    if (main) {
      const text = main.textContent.trim();
      // æŠ“å‡º Day X å¾Œé¢çš„æ‰€æœ‰æ–‡å­—
      const m = text.match(/^Day\s+\d+(.*)$/i);
      if (m) {
        main.textContent = "Day " + num + (m[1] || "");
      }
    }

    // ä¸‹æ–¹å°æ‡‰çš„ Day å€å¡Šæ¨™é¡Œ
    const sec = Array.from(sections).find(s => s.dataset.dayId === id);
    if (sec) {
      const titleMain = sec.querySelector(".day-title-main");
      if (titleMain) {
        const t = titleMain.textContent.trim();
        const m2 = t.match(/^Day\s+\d+(.*)$/i);
        if (m2) {
          titleMain.textContent = "Day " + num + (m2[1] || "");
        }
      }
    }
  });
}
    /* è¡Œç¨‹å¡ç‰‡æ‹–æ‹‰ï¼ˆåªå‹• .spot-cardï¼Œä¸å‹•æ–°å¢å¡ï¼†å‚™è¨»ï¼‰ */
    let draggingSpot = null;
    function attachSpotDragEvents() {
      const bodies = content.querySelectorAll(".day-body");
      bodies.forEach(body => {
        body.removeEventListener("dragover", onDayBodyDragOver);
        body.removeEventListener("drop", onDayBodyDrop);
        body.addEventListener("dragover", onDayBodyDragOver);
        body.addEventListener("drop", onDayBodyDrop);
      });

      const spots = content.querySelectorAll(".spot-card");
      spots.forEach(card => {
        card.removeEventListener("dragstart", onSpotDragStart);
        card.removeEventListener("dragend", onSpotDragEnd);
        card.addEventListener("dragstart", onSpotDragStart);
        card.addEventListener("dragend", onSpotDragEnd);
      });
    }

    function onSpotDragStart(e) {
      draggingSpot = e.currentTarget;
      e.currentTarget.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }
    function onSpotDragEnd(e) {
      if (draggingSpot) draggingSpot.classList.remove("dragging");
      draggingSpot = null;
      scheduleSave();
    }
    function onDayBodyDragOver(e) {
      e.preventDefault();
      if (!draggingSpot) return;
      const body = e.currentTarget;
      const after = getVerticalAfterElement(body, e.clientY);
      if (!after) {
        // æ’åœ¨ã€Œæ–°å¢è¡Œç¨‹å¡ç‰‡ã€ä¹‹å‰ï¼ˆå‚™è¨»æ°¸é ç•™åœ¨æœ€å¾Œï¼‰
        const addCard = body.querySelector(".add-spot-card");
        body.insertBefore(draggingSpot, addCard);
      } else {
        body.insertBefore(draggingSpot, after);
      }
    }
    function onDayBodyDrop(e) {
      e.preventDefault();
      scheduleSave();
    }
    function getVerticalAfterElement(container, y) {
      const els = [...container.querySelectorAll(".spot-card:not(.dragging)")];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    }

    /* æ–°å¢è¡Œç¨‹å¡ç‰‡äº‹ä»¶ */
    function attachAddSpotEvents() {
      const addBtns = content.querySelectorAll(".btn-add-spot");
      addBtns.forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".add-spot-card");
          const body = card.closest(".day-body");
          const zh = card.querySelector(".input-spot-zh").value.trim() || "æ™¯é»åç¨±";
          const ja = card.querySelector(".input-spot-ja").value.trim() || "æ—¥æ–‡åç¨±æˆ–åœ°å€";
          const spot = createSpotCard(zh, ja);
          body.insertBefore(spot, card);
          card.querySelector(".input-spot-zh").value = "";
          card.querySelector(".input-spot-ja").value = "";
          bindAllEvents(spot);
          scheduleSave();
        };
      });
    }

    /* ç…§ç‰‡æŒ‰éˆ•ï¼ˆè¡Œç¨‹å¡ï¼‹ç•¶æ—¥å‚™è¨»ï¼‰ */
    function attachPhotoEvents() {
      const photoBtns = content.querySelectorAll(".btn-photo");
      photoBtns.forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".spot-card");
          const list = card.querySelector(".image-list");
          currentPhotoTarget = list;
          const input = document.getElementById("photoInput");
          input.value = "";
          input.click();
        };
      });
    }

    function attachNotePhotoEvents() {
      const noteBtns = content.querySelectorAll(".btn-daynote-photo");
      noteBtns.forEach(btn => {
        btn.onclick = () => {
          const note = btn.closest(".day-note-block");
          const list = note.querySelector(".image-list");
          currentPhotoTarget = list;
          const input = document.getElementById("photoInput");
          input.value = "";
          input.click();
        };
      });
    }

    document.getElementById("photoInput").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file || !currentPhotoTarget) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const url = ev.target.result;
        const img = document.createElement("img");
        img.className = "spot-photo";
        img.src = url;
        img.alt = "ç…§ç‰‡";
        img.onclick = () => {
          if (confirm("è¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) {
            img.remove();
            scheduleSave();
          }
        };
        currentPhotoTarget.appendChild(img);
        scheduleSave();
      };
      reader.readAsDataURL(file);
    });

    /* header ä¸Šæ–¹æŒ‰éˆ•ï¼šæ–°å¢ï¼åˆªé™¤å¤©ã€å‚™ä»½ */
    function attachHeaderButtons() {
      const addDayBtn = document.getElementById("addDayBtn");
      const removeDayBtn = document.getElementById("removeLastDayBtn");
      const exportBtn = document.getElementById("backupExportBtn");
      const importBtn = document.getElementById("backupImportBtn");
      const fileInput = document.getElementById("backupImportFile");

      if (addDayBtn) {
        addDayBtn.onclick = () => {
          addNewDay();
          scheduleSave();
        };
      }
      if (removeDayBtn) {
        removeDayBtn.onclick = () => {
          const sections = content.querySelectorAll(".day-section");
          if (sections.length <= 1) {
            alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©è¡Œç¨‹å–”ï¼");
            return;
          }
          const lastSec = sections[sections.length - 1];
          const lastId = lastSec.dataset.dayId;
          lastSec.remove();
          const lastChip = navRow.querySelector(`.day-chip[data-day-id="${lastId}"]`);
          if (lastChip) lastChip.remove();
          recalcDayNumbers();
          scheduleSave();
        };
      }
      if (exportBtn) {
        exportBtn.onclick = () => {
          const data = getSavedData();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "NijiTrip2026_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        };
      }
      if (importBtn) {
        importBtn.onclick = () => {
          fileInput.value = "";
          fileInput.click();
        };
      }
      if (fileInput) {
        fileInput.onchange = (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              const data = JSON.parse(ev.target.result);
              restoreData(data);
              saveImmediate();
            } catch (err) {
              alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤");
            }
          };
          reader.readAsText(file, "utf-8");
        };
      }
    }

    /* æ–°å¢ä¸€å¤©ï¼šè‡ªå‹•æ¥çºŒæ—¥æœŸ */
    function addNewDay() {
      let nextDate = new Date(YEAR, 4, 8); // default 5/8
      const sections = content.querySelectorAll(".day-section");
      if (sections.length > 0) {
        const lastSec = sections[sections.length - 1];
        const iso = lastSec.dataset.dateIso;
        if (iso) {
          const d = new Date(iso);
          d.setDate(d.getDate() + 1);
          nextDate = d;
        } else {
          // å¦‚æœæ²’æœ‰ isoï¼Œå°±è©¦è‘—å¾æ¨™é¡ŒæŠ“ mm/dd
          const lastDateText = lastSec.querySelector(".day-title-date")?.textContent.trim() || "5/8";
          const [m, dd] = lastDateText.split("/").map(x => parseInt(x, 10));
          const d = new Date(YEAR, (m || 5) - 1, dd || 8);
          d.setDate(d.getDate() + 1);
          nextDate = d;
        }
      }
      const dayCount = sections.length + 1;
      createDay(dayCount, nextDate);
      bindAllEvents();
      recalcDayNumbers();
    }

    /* å„²å­˜ï¼è®€å–è³‡æ–™ï¼ˆlocalStorageï¼‰ */
    function getSavedData() {
      return {
        headerHTML: document.querySelector("header").innerHTML,
        navHTML: navRow.innerHTML,
        contentHTML: content.innerHTML
      };
    }

    function restoreData(data) {
      if (!data) return;
      document.querySelector("header").innerHTML = data.headerHTML;
      navRow.innerHTML = data.navHTML;
      content.innerHTML = data.contentHTML;
      bindAllEvents();
      recalcDayNumbers();
    }

    function saveImmediate() {
      const data = getSavedData();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    let saveTimer = null;
    function scheduleSave() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(saveImmediate, 400);
    }

    function tryRestoreFromLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        restoreData(data);
        return true;
      } catch (e) {
        console.error(e);
        return false;
      }
    }

    /* åˆå§‹åŒ– */
    document.addEventListener("DOMContentLoaded", () => {
      const restored = tryRestoreFromLocal();
      if (!restored) {
        // é è¨­å¾ 2026/5/8 é–‹å§‹ 14 å¤©
        const start = new Date(YEAR, 4, 8); // 5æœˆ index=4
        const total = 14;
        for (let i = 0; i < total; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);
          createDay(i + 1, d);
        }
        bindAllEvents();
        recalcDayNumbers();
        saveImmediate();
      } else {
        // localStorage å·²æœ‰è³‡æ–™ï¼Œbind events å·²åœ¨ restoreData è£¡åš
      }
    });
  </script>
</body>
</html>
