<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026 è¡Œç¨‹è¡¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #ffe2b8;
      --bg-card: #fff7e8;
      --bg-day: #e8f6ff;
      --bg-note: #fff4dd;
      --accent: #ffb347;
      --accent-soft: #ffe0b5;
      --accent-strong: #ff8c42;
      --border-soft: #f1cfa0;
      --text-main: #5b3b25;
      --text-sub: #8c6b4a;
      --shadow-soft: 0 2px 6px rgba(0,0,0,0.08);
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 12px 40px;
    }

    /* -------------- é ‚éƒ¨ Header -------------- */
    header {
      background: #ffe7c4;
      border-radius: 0 0 26px 26px;
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
      margin: 0 -12px 6px;
    }

    .trip-title {
      font-size: 28px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .trip-title span[contenteditable] {
      outline: none;
    }

    .trip-desc {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-sub);
      margin-bottom: 8px;
    }

    .trip-desc[contenteditable] {
      outline: none;
    }

    .trip-hint {
      font-size: 13px;
      color: var(--text-sub);
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 12px;
    }

    .trip-hint-emoji {
      margin-top: 1px;
    }

    .top-btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      background: var(--accent-soft);
      color: var(--text-main);
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      white-space: nowrap;
    }

    .btn--danger {
      background: #ffd2c5;
      color: #8a3c32;
    }

    .btn--primary {
      background: var(--accent-strong);
      color: white;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    input[type="file"] {
      display: none;
    }

    /* -------------- Day å°è¦½åˆ— -------------- */
    .day-nav-wrap {
      margin-top: 10px;
      padding: 8px 0 6px;
      background: #e5f3ff;
      border-radius: 24px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .day-nav-wrap::-webkit-scrollbar {
      display: none;
    }

    .day-nav-row {
      display: flex;
      gap: 8px;
      padding: 0 10px;
    }

    .day-chip {
      min-width: 92px;
      background: #fff;
      border-radius: 999px;
      padding: 6px 12px;
      text-align: center;
      box-shadow: var(--shadow-soft);
      cursor: grab;
      user-select: none;
    }

    .day-chip.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }

    .day-chip-main {
      font-size: 15px;
      font-weight: 700;
    }

    .day-chip-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .day-chip-main[contenteditable],
    .day-chip-sub[contenteditable] {
      outline: none;
    }

    /* -------------- Day å€å¡Š -------------- */
    .day-section {
      margin-top: 10px;
      background: var(--bg-day);
      border-radius: 26px;
      padding: 12px 10px 14px;
      box-shadow: var(--shadow-soft);
    }

    .day-title {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      background: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      box-shadow: 0 2px 4px rgba(160,190,210,0.3);
      margin-bottom: 10px;
    }

    .day-title-main {
      font-size: 17px;
      font-weight: 800;
    }

    .day-title-extra {
      font-size: 14px;
      color: var(--text-sub);
      outline: none;
    }

    .day-title-extra[contenteditable] {
      min-width: 40px;
    }

    /* -------------- ç•¶æ—¥å‚™è¨»å¡ -------------- */
    .daily-note-card {
      background: var(--bg-note);
      border-radius: var(--radius-lg);
      padding: 10px 12px 12px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
      position: relative;
    }

    .daily-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .daily-note-title {
      font-weight: 700;
      font-size: 15px;
    }

    .daily-note-text {
      font-size: 13px;
      color: var(--text-sub);
      background: #fff9ee;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      min-height: 42px;
      outline: none;
      white-space: pre-wrap;
    }

    .daily-note-photo-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .daily-note-photos {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .daily-note-photo {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .photo-delete-hint {
      font-size: 11px;
      color: var(--text-sub);
    }

    /* -------------- æ–°å¢è¡Œç¨‹å¡ç‰‡ -------------- */
    .add-spot-card {
      background: #fffdf7;
      border-radius: var(--radius-lg);
      padding: 10px 12px 12px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
    }

    .add-spot-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .add-spot-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .add-spot-input {
      flex: 1 1 140px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
    }

    .add-spot-input::placeholder {
      color: #c0a28a;
    }

    /* -------------- è¡Œç¨‹å¡ç‰‡ -------------- */
    .spot-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 8px;
    }

    .spot-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 10px 12px 10px;
      box-shadow: var(--shadow-soft);
      position: relative;
      cursor: grab;
    }

    .spot-card.dragging {
      opacity: 0.7;
      cursor: grabbing;
    }

    .spot-text {
      margin-bottom: 8px;
    }

    .name-zh,
    .name-ja,
    .spot-meta {
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      outline: none;
    }

    .name-zh {
      font-weight: 700;
      margin-bottom: 2px;
    }

    .name-ja {
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .spot-meta {
      font-size: 13px;
      color: var(--text-sub);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-ghost {
      background: #fff;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      box-shadow: none;
    }

    .btn-danger-sm {
      background: #ffe1dd;
      color: #9c3d3d;
    }

    .drag-hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    /* spot å‚™è¨» */
    .spot-note {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-soft);
      background: #fffdf7;
      padding: 6px 8px;
    }

    .spot-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .spot-note-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-sub);
    }

    .spot-note-body {
      font-size: 12px;
      color: var(--text-sub);
      white-space: pre-wrap;
      outline: none;
      min-height: 32px;
    }

    .spot-note-photo-row {
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
    }

    .spot-note-photos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .spot-photo {
      width: 54px;
      height: 54px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* -------------- åº•éƒ¨å›ä¸Šä¸€æ­¥ -------------- */
    .back-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .back-btn {
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      background: #ffd9a8;
      border: none;
      box-shadow: var(--shadow-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-btn:active {
      transform: translateY(1px);
    }

    @media (max-width: 600px) {
      .trip-title {
        font-size: 24px;
      }
      .spot-card {
        padding: 10px 10px 9px;
      }
      .day-title {
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="trip-title">
        <span id="tripTitle" contenteditable="true">Niji Trip 2026</span>
        <span>ğŸŒˆ</span>
      </div>
      <p id="tripDesc" class="trip-desc" contenteditable="true">
        æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œãƒ»è¡Œç¨‹æ¬„ä½å¯æ‹–æ‹‰æ’åºï¼Œå¤©æ•¸å¯æ‹–æ‹‰é‡æ’ï¼‹è‡ªå‹• Day ç·¨è™Ÿã€‚
      </p>
      <div class="trip-hint">
        <span class="trip-hint-emoji">ğŸ“</span>
        <span id="tripHint" contenteditable="true">
          æ¯ä¸€å¤©çš„ã€Œç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ã€ç¶­æŒåœ¨æœ€ä¸‹æ–¹ï¼Œæ–‡å­—å¯ç·¨è¼¯ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ç…§ç‰‡ã€‚è¡Œç¨‹å¡å¯ä»¥æ‹–æ‹‰èª¿æ•´é †åºã€åŠ å…¥åœ–ç‰‡ã€é–‹å•Ÿåœ°åœ–é è¦½ã€‚è³‡æ–™æœƒè‡ªå‹•å„²å­˜ï¼Œä¹Ÿå¯ä»¥åŒ¯å‡º JSON ä¸Šå‚³é›²ç«¯ã€‚
        </span>
      </div>
      <div class="top-btn-row">
        <button class="btn btn--danger" id="btnDeleteLastDay">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="btnExport">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn btn--primary" id="btnAddDay">ï¼‹ æ–°å¢ä¸€å¤©</button>
      </div>
      <input type="file" id="backupFileInput" accept="application/json" />
    </header>

    <!-- Day å°è¦½åˆ— -->
    <div class="day-nav-wrap">
      <div class="day-nav-row" id="dayNav">
        <!-- JS ç”¢ç”Ÿ Day Chips -->
      </div>
    </div>

    <!-- æ‰€æœ‰ Day å€å¡Š -->
    <div id="daysContainer">

      <!-- ç¯„ä¾‹ï¼šDay 1 -->
      <section class="day-section" id="day-1" data-date="2026-05-08">
        <div class="day-title">
          <span class="day-title-main">Day 1</span>
          <span class="day-title-extra day-date-text" contenteditable="true">ï¼ˆ5/8ï¼‰</span>
        </div>

        <!-- ç•¶æ—¥å‚™è¨»ï¼èŠ±è²» -->
        <div class="daily-note-card">
          <div class="daily-note-header">
            <div class="daily-note-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
            <button class="btn btn-sm btn-ghost" data-daily-note-photo-btn>ğŸ“· æ–°å¢åœ–ç‰‡</button>
          </div>
          <div class="daily-note-text" contenteditable="true">
ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦
          </div>
          <div class="daily-note-photo-row">
            <div class="daily-note-photos" data-daily-note-photos></div>
          </div>
        </div>

        <!-- æ–°å¢è¡Œç¨‹å¡ç‰‡ -->
        <div class="add-spot-card">
          <div class="add-spot-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
          <div class="add-spot-row">
            <input
              class="add-spot-input"
              type="text"
              placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰"
              data-add-name-zh
            />
            <input
              class="add-spot-input"
              type="text"
              placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€"
              data-add-name-ja
            />
          </div>
          <button class="btn btn-sm btn--primary" data-add-spot-btn>æ–°å¢</button>
        </div>

        <!-- è¡Œç¨‹å¡ç‰‡åˆ—è¡¨ -->
        <div class="spot-list" data-spot-list>
          <article class="spot-card" draggable="true">
            <div class="spot-text">
              <div class="name-zh" contenteditable="true">ç¯„ä¾‹æ™¯é»</div>
              <div class="name-ja" contenteditable="true">æ—¥æ–‡åç¨±æˆ–åœ°å€</div>
              <div class="spot-meta" contenteditable="true">
åœ°å€ãƒ»ç°¡çŸ­èªªæ˜å¯å¯«åœ¨é€™è£¡
              </div>
            </div>

            <div class="btn-row">
              <button class="btn btn-sm btn-ghost" data-open-map>åœ°åœ–é è¦½</button>
              <button class="btn btn-sm btn-ghost" data-spot-photo-btn>ğŸ“· æ–°å¢åœ–ç‰‡</button>
              <button class="btn btn-sm btn-ghost" data-spot-delete-btn>åˆªé™¤å¡ç‰‡</button>
            </div>

            <div class="drag-hint">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>

            <div class="spot-note">
              <div class="spot-note-header">
                <div class="spot-note-title">å‚™è¨»</div>
                <button class="btn btn-sm btn-ghost" data-spot-note-photo-btn>ğŸ“· æ–°å¢åœ–ç‰‡</button>
              </div>
              <div class="spot-note-body" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
              </div>
              <div class="spot-note-photo-row">
                <div class="spot-note-photos" data-spot-note-photos></div>
              </div>
            </div>

            <div class="spot-note-photo-row" style="margin-top:6px; justify-content:flex-start;">
              <div class="spot-note-photos" data-spot-photos></div>
            </div>
          </article>
        </div>

        <!-- ç•¶æ—¥å›ä¸Šä¸€æ­¥ï¼ˆåªæ˜¯ä¸€å€‹æé†’æŒ‰éˆ•ï¼Œå¯è‡ªå·±æ±ºå®šç”¨é€”ï¼‰ -->
        <div class="back-row">
          <button class="back-btn">âª å›ä¸Šä¸€æ­¥</button>
        </div>
      </section>

      <!-- å¯ä»¥å†æ‰‹å‹•è¤‡è£½å¤šå¹¾å€‹ Day å€å¡Šç•¶ç¯„ä¾‹ï¼›JS æœƒè‡ªå‹•é‡æ–°ç·¨è™Ÿèˆ‡æ’æ—¥æœŸ -->

    </div>

    <!-- å…¨ç«™å…±ç”¨çš„éš±è— inputï¼Œçµ¦æ‰€æœ‰ã€Œæ–°å¢åœ–ç‰‡ã€å…±ç”¨ -->
    <input type="file" id="photoInputSpot" accept="image/*" />
    <input type="file" id="photoInputDaily" accept="image/*" />
  </main>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tripTitle = document.getElementById("tripTitle");
      const tripDesc = document.getElementById("tripDesc");
      const tripHint = document.getElementById("tripHint");

      const dayNav = document.getElementById("dayNav");
      const daysContainer = document.getElementById("daysContainer");

      const btnAddDay = document.getElementById("btnAddDay");
      const btnDeleteLastDay = document.getElementById("btnDeleteLastDay");
      const btnExport = document.getElementById("btnExport");
      const btnImport = document.getElementById("btnImport");
      const backupFileInput = document.getElementById("backupFileInput");

      const photoInputSpot = document.getElementById("photoInputSpot");
      const photoInputDaily = document.getElementById("photoInputDaily");

      const STORAGE_KEY = "nijiTrip2026_state_v1";

      let currentPhotoTarget = null; // ç›®å‰è¦å¡åœ–ç‰‡çš„å®¹å™¨
      let saveTimer = null;

      /* ---------------- åŸºæœ¬å·¥å…· ---------------- */

      function getDaySections() {
        return Array.from(daysContainer.querySelectorAll(".day-section"));
      }

      function formatMonthDay(date) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        return `${m}/${d}`;
      }

      function parseISODate(str) {
        const d = new Date(str);
        if (Number.isNaN(d.getTime())) return null;
        return d;
      }

      function getBaseDate() {
        const days = getDaySections();
        if (!days.length) return new Date();
        const first = days[0];
        const iso = first.dataset.date || "2026-05-08";
        const d = parseISODate(iso) || new Date();
        return d;
      }

      function debounceSave() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(saveState, 400);
      }

      /* ---------------- Day ç·¨è™Ÿ / æ—¥æœŸ / å°è¦½åˆ— ---------------- */

      function recomputeDaysAndNav() {
        const days = getDaySections();
        if (!days.length) {
          dayNav.innerHTML = "";
          return;
        }

        const baseDate = getBaseDate();
        const navFrag = document.createDocumentFragment();

        days.forEach((section, index) => {
          const dayIndex = index + 1;
          const dayId = `day-${dayIndex}`;
          section.id = dayId;

          // è¨ˆç®—æ—¥æœŸ
          const d = new Date(baseDate);
          d.setDate(baseDate.getDate() + index);
          section.dataset.date = d.toISOString().slice(0, 10);
          const mdText = `ï¼ˆ${formatMonthDay(d)}ï¼‰`;

          // æ›´æ–° Day Title
          const titleMain = section.querySelector(".day-title-main");
          if (titleMain) titleMain.textContent = `Day ${dayIndex}`;

          const dateText = section.querySelector(".day-date-text");
          if (dateText) dateText.textContent = mdText;

          // å°è¦½åˆ— chip
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "day-chip";
          chip.dataset.targetId = dayId;

          const chipMain = document.createElement("div");
          chipMain.className = "day-chip-main";
          chipMain.textContent = `Day ${dayIndex}`;

          const chipSub = document.createElement("div");
          chipSub.className = "day-chip-sub";
          chipSub.textContent = formatMonthDay(d);

          chip.appendChild(chipMain);
          chip.appendChild(chipSub);

          chip.addEventListener("click", () => {
            section.scrollIntoView({ behavior: "smooth", block: "start" });
          });

          navFrag.appendChild(chip);
        });

        dayNav.innerHTML = "";
        dayNav.appendChild(navFrag);
      }

      /* ---------------- å»ºç«‹æ–° Day / Spot ---------------- */

      function makeSpotCardDraggable(card) {
        card.setAttribute("draggable", "true");
      }

      function createSpotCard(nameZh = "", nameJa = "", meta = "") {
        const card = document.createElement("article");
        card.className = "spot-card";
        card.setAttribute("draggable", "true");
        card.innerHTML = `
          <div class="spot-text">
            <div class="name-zh" contenteditable="true">${nameZh || "æ–°æ™¯é»"}</div>
            <div class="name-ja" contenteditable="true">${nameJa || "æ—¥æ–‡åç¨±æˆ–åœ°å€"}</div>
            <div class="spot-meta" contenteditable="true">${meta || "åœ°å€ãƒ»ç°¡çŸ­èªªæ˜å¯å¯«åœ¨é€™è£¡"}</div>
          </div>

          <div class="btn-row">
            <button class="btn btn-sm btn-ghost" data-open-map>åœ°åœ–é è¦½</button>
            <button class="btn btn-sm btn-ghost" data-spot-photo-btn>ğŸ“· æ–°å¢åœ–ç‰‡</button>
            <button class="btn btn-sm btn-ghost btn-danger-sm" data-spot-delete-btn>åˆªé™¤å¡ç‰‡</button>
          </div>

          <div class="drag-hint">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>

          <div class="spot-note">
            <div class="spot-note-header">
              <div class="spot-note-title">å‚™è¨»</div>
              <button class="btn btn-sm btn-ghost" data-spot-note-photo-btn>ğŸ“· æ–°å¢åœ–ç‰‡</button>
            </div>
            <div class="spot-note-body" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
            </div>
            <div class="spot-note-photo-row">
              <div class="spot-note-photos" data-spot-note-photos></div>
            </div>
          </div>

          <div class="spot-note-photo-row" style="margin-top:6px; justify-content:flex-start;">
            <div class="spot-note-photos" data-spot-photos></div>
          </div>
        `;
        return card;
      }

      function createDaySection(dateISO) {
        const baseDay = getDaySections()[0];
        const section = baseDay.cloneNode(true);

        // æ¸…ç©º ID / æ—¥æœŸç­‰ï¼Œå…ˆæš«æ™‚è¨­ç‚ºä»Šå¤©ï¼Œå¾Œé¢ recomputeDaysAndNav æœƒæ”¹
        section.id = "";
        section.dataset.date =
          dateISO ||
          new Date().toISOString().slice(0, 10);

        // æ¸…ç©º spot-list
        const list = section.querySelector("[data-spot-list]");
        if (list) {
          list.innerHTML = "";
        }

        // é‡è¨­æ¯æ—¥å‚™è¨»
        const dailyText = section.querySelector(".daily-note-text");
        if (dailyText) {
          dailyText.textContent =
            "ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦";
        }
        const dailyPhotos = section.querySelector("[data-daily-note-photos]");
        if (dailyPhotos) dailyPhotos.innerHTML = "";

        return section;
      }

      function addNewDay() {
        const days = getDaySections();
        let newDate;
        if (days.length) {
          const last = days[days.length - 1];
          const lastDate = parseISODate(last.dataset.date) || new Date();
          newDate = new Date(lastDate);
          newDate.setDate(lastDate.getDate() + 1);
        } else {
          newDate = new Date();
        }
        const iso = newDate.toISOString().slice(0, 10);
        const newSection = createDaySection(iso);
        daysContainer.appendChild(newSection);
        makeAllSpotCardsDraggable();
        recomputeDaysAndNav();
        debounceSave();
      }

      function deleteLastDay() {
        const days = getDaySections();
        if (days.length <= 1) {
          alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©è¡Œç¨‹å”·ï¼");
          return;
        }
        const last = days[days.length - 1];
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${last.querySelector(".day-title-main")?.textContent || "æœ€å¾Œä¸€å¤©"} å—ï¼Ÿ`)) {
          return;
        }
        last.remove();
        recomputeDaysAndNav();
        debounceSave();
      }

      /* ---------------- Spot Drag & Drop ---------------- */

      let draggingCard = null;

      function makeAllSpotCardsDraggable() {
        daysContainer
          .querySelectorAll(".spot-card")
          .forEach((card) => makeSpotCardDraggable(card));
      }

      function getDragAfterElement(container, y) {
        const cards = [
          ...container.querySelectorAll(".spot-card:not(.dragging)"),
        ];
        return cards.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - (box.top + box.height / 2);
            if (offset < 0 && offset > closest.offset) {
              return { offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY, element: null }
        ).element;
      }

      daysContainer.addEventListener("dragstart", (e) => {
        const card = e.target.closest(".spot-card");
        if (!card) return;
        draggingCard = card;
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      });

      daysContainer.addEventListener("dragend", (e) => {
        const card = e.target.closest(".spot-card");
        if (card) {
          card.classList.remove("dragging");
        }
        draggingCard = null;
        debounceSave();
      });

      daysContainer.addEventListener("dragover", (e) => {
        if (!draggingCard) return;
        e.preventDefault();
        const list =
          e.target.closest("[data-spot-list]") ||
          draggingCard.closest("[data-spot-list]");
        if (!list) return;
        const afterElement = getDragAfterElement(list, e.clientY);
        if (afterElement == null) {
          list.appendChild(draggingCard);
        } else {
          list.insertBefore(draggingCard, afterElement);
        }
      });

      /* ---------------- åœ–ç‰‡è™•ç† ---------------- */

      function handleSpotPhotos(files) {
        if (!currentPhotoTarget) return;
        Array.from(files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = document.createElement("img");
            img.src = ev.target.result;
            img.className = "spot-photo";
            currentPhotoTarget.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
        debounceSave();
      }

      function handleDailyPhotos(files) {
        if (!currentPhotoTarget) return;
        Array.from(files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = document.createElement("img");
            img.src = ev.target.result;
            img.className = "spot-photo";
            currentPhotoTarget.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
        debounceSave();
      }

      photoInputSpot.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files && files.length) {
          handleSpotPhotos(files);
        }
        photoInputSpot.value = "";
      });

      photoInputDaily.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files && files.length) {
          handleDailyPhotos(files);
        }
        photoInputDaily.value = "";
      });

      // é»æ“Šåœ–ç‰‡åˆªé™¤
      daysContainer.addEventListener("click", (e) => {
        const img = e.target.closest("img.spot-photo");
        if (!img) return;
        if (confirm("è¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) {
          img.remove();
          debounceSave();
        }
      });

      /* ---------------- Day å…§éƒ¨æŒ‰éˆ• / äº‹ä»¶å§”æ´¾ ---------------- */

      daysContainer.addEventListener("click", (e) => {
        const target = e.target;

        // æ–°å¢è¡Œç¨‹å¡ç‰‡
        if (target.matches("[data-add-spot-btn]")) {
          const daySection = target.closest(".day-section");
          const list = daySection.querySelector("[data-spot-list]");
          const inputZh = daySection.querySelector("[data-add-name-zh]");
          const inputJa = daySection.querySelector("[data-add-name-ja]");

          const nameZh = (inputZh?.value || "").trim();
          const nameJa = (inputJa?.value || "").trim();

          const card = createSpotCard(nameZh, nameJa, "");
          makeSpotCardDraggable(card);
          list.appendChild(card);

          if (inputZh) inputZh.value = "";
          if (inputJa) inputJa.value = "";

          debounceSave();
          return;
        }

        // åˆªé™¤è¡Œç¨‹å¡ç‰‡
        if (target.matches("[data-spot-delete-btn]")) {
          const card = target.closest(".spot-card");
          if (!card) return;
          if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µè¡Œç¨‹å¡ç‰‡å—ï¼Ÿ")) {
            card.remove();
            debounceSave();
          }
          return;
        }

        // æ™¯é»åœ–ç‰‡
        if (target.matches("[data-spot-photo-btn]")) {
          const card = target.closest(".spot-card");
          if (!card) return;
          const photos = card.querySelector("[data-spot-photos]");
          if (!photos) return;
          currentPhotoTarget = photos;
          photoInputSpot.click();
          return;
        }

        // æ™¯é»å‚™è¨»åœ–ç‰‡
        if (target.matches("[data-spot-note-photo-btn]")) {
          const note = target.closest(".spot-note");
          if (!note) return;
          const photos = note.querySelector("[data-spot-note-photos]");
          if (!photos) return;
          currentPhotoTarget = photos;
          photoInputSpot.click();
          return;
        }

        // ç•¶æ—¥å‚™è¨»åœ–ç‰‡
        if (target.matches("[data-daily-note-photo-btn]")) {
          const card = target.closest(".daily-note-card");
          if (!card) return;
          const photos = card.querySelector("[data-daily-note-photos]");
          if (!photos) return;
          currentPhotoTarget = photos;
          photoInputDaily.click();
          return;
        }

        // åœ°åœ–é è¦½
        if (target.matches("[data-open-map]")) {
          const card = target.closest(".spot-card");
          if (!card) return;
          const nameZh = card.querySelector(".name-zh")?.textContent.trim();
          const nameJa = card.querySelector(".name-ja")?.textContent.trim();
          const q = encodeURIComponent(nameJa || nameZh || "");
          const url = `https://www.google.com/maps/search/?api=1&query=${q}`;
          window.open(url, "_blank");
          return;
        }
      });

      // æ–‡å­—è®Šæ›´å°±å­˜æª”ï¼ˆæ‰€æœ‰ contenteditable & inputï¼‰
      daysContainer.addEventListener("input", (e) => {
        if (
          e.target.matches("[contenteditable], input, textarea")
        ) {
          debounceSave();
        }
      });
      tripTitle.addEventListener("input", debounceSave);
      tripDesc.addEventListener("input", debounceSave);
      tripHint.addEventListener("input", debounceSave);

      /* ---------------- åŒ¯å‡º / åŒ¯å…¥ / localStorage ---------------- */

      function getStateObject() {
        return {
          title: tripTitle.innerHTML,
          desc: tripDesc.innerHTML,
          hint: tripHint.innerHTML,
          daysHTML: daysContainer.innerHTML,
        };
      }

      function applyStateObject(state) {
        if (!state) return;
        if (state.title) tripTitle.innerHTML = state.title;
        if (state.desc) tripDesc.innerHTML = state.desc;
        if (state.hint) tripHint.innerHTML = state.hint;
        if (state.daysHTML) daysContainer.innerHTML = state.daysHTML;

        makeAllSpotCardsDraggable();
        recomputeDaysAndNav();
      }

      function saveState() {
        try {
          const state = getStateObject();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (err) {
          console.warn("å„²å­˜å¤±æ•—ï¼š", err);
        }
      }

      function restoreState() {
        try {
          const txt = localStorage.getItem(STORAGE_KEY);
          if (!txt) return;
          const state = JSON.parse(txt);
          applyStateObject(state);
        } catch (err) {
          console.warn("è®€å–å¤±æ•—ï¼š", err);
        }
      }

      btnExport.addEventListener("click", () => {
        try {
          const state = getStateObject();
          const blob = new Blob([JSON.stringify(state, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "NijiTrip2026_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("åŒ¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ QQ");
          console.error(err);
        }
      });

      btnImport.addEventListener("click", () => {
        backupFileInput.value = "";
        backupFileInput.click();
      });

      backupFileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const state = JSON.parse(reader.result);
            applyStateObject(state);
            saveState();
          } catch (err) {
            alert("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼å¯èƒ½ä¸æ­£ç¢º");
            console.error(err);
          }
        };
        reader.readAsText(file, "utf-8");
      });

      /* ---------------- é é¢åˆå§‹åŒ– ---------------- */

      function init() {
        // å…ˆå˜—è©¦å¾ localStorage é‚„åŸ
        restoreState();
        // ç¢ºä¿ç›®å‰ DOM è£¡çš„ spot-card éƒ½å¯æ‹–æ‹‰
        makeAllSpotCardsDraggable();
        // å»ºç«‹ Day å°è¦½åˆ— & è‡ªå‹•æ—¥æ•¸
        recomputeDaysAndNav();
      }

      init();

      // ä¸Šæ–¹æ–°å¢ / åˆªé™¤æœ€å¾Œä¸€å¤©
      btnAddDay.addEventListener("click", () => {
        addNewDay();
      });

      btnDeleteLastDay.addEventListener("click", () => {
        deleteLastDay();
      });
    });
  </script>
</body>
</html>
