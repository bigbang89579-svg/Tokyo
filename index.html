<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #fff7e8;
      --bg-card: #fffaf0;
      --bg-day: #e9f6ff;
      --orange-main: #ffb84d;
      --orange-soft: #ffe2ad;
      --brown-main: #62401f;
      --brown-soft: #9c7350;
      --border-soft: #f2d6aa;
      --accent: #ff7f7f;
      --shadow-soft: 0 2px 4px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--brown-main);
    }
    header {
      background: #ffe7c4;
      padding: 16px 16px 10px;
      border-radius: 0 0 24px 24px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 26px;
      letter-spacing: 1px;
    }
    header p {
      margin: 2px 0;
      font-size: 13px;
      line-height: 1.5;
    }
    .header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      background: var(--orange-soft);
      color: var(--brown-main);
      box-shadow: var(--shadow-soft);
      white-space: nowrap;
    }
    .btn.primary {
      background: var(--orange-main);
      font-weight: 600;
    }
    .btn.danger {
      background: #ffd0c8;
      color: #b03a2e;
    }
    .btn.small {
      padding: 4px 9px;
      font-size: 11px;
      box-shadow: none;
    }
    .btn-ghost {
      background: transparent;
      border: 1px dashed var(--border-soft);
      box-shadow: none;
    }

    /* Day nav */
    .day-nav-wrap {
      background: var(--bg-day);
      padding: 8px 0 10px;
      margin-bottom: 4px;
    }
    .day-nav-row {
      display: flex;
      gap: 8px;
      padding: 0 10px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    .day-chip {
      flex: 0 0 auto;
      min-width: 80px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #fff;
      box-shadow: var(--shadow-soft);
      text-align: center;
      cursor: grab;
      user-select: none;
    }
    .day-chip.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .day-chip-main {
      display: block;
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .day-chip-sub {
      display: block;
      font-size: 11px;
      color: var(--brown-soft);
    }

    /* Content layout */
    .page {
      padding: 8px 10px 80px;
    }
    .day-section {
      background: #f3fbff;
      border-radius: 20px;
      padding: 10px 10px 14px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-soft);
    }
    .day-title {
      font-weight: 700;
      font-size: 17px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #ffffff;
      margin-bottom: 8px;
      display: inline-block;
    }
    .day-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .day-block {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 10px 10px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f8ebd7;
      cursor: grab;
    }
    .day-block.dragging {
      opacity: 0.6;
    }

    /* Daily note block */
    .day-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }
    .day-note-title {
      font-weight: 700;
      font-size: 15px;
    }
    .day-note-box {
      border-radius: 12px;
      border: 1px dashed var(--border-soft);
      padding: 8px 8px 6px;
      font-size: 13px;
      background: #fffdf7;
      min-height: 40px;
    }

    /* Spot card */
    .spot-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .spot-name-zh {
      font-size: 16px;
      font-weight: 700;
    }
    .spot-name-ja {
      font-size: 13px;
      color: var(--brown-soft);
      margin-top: 2px;
    }
    .spot-meta {
      font-size: 12px;
      color: var(--brown-soft);
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0 4px;
    }
    .drag-hint {
      font-size: 11px;
      color: var(--brown-soft);
      margin-top: 2px;
    }

    /* Add spot form */
    .add-spot-card {
      background: #fffef8;
      border-radius: 16px;
      padding: 10px;
      border: 1px dashed var(--border-soft);
      box-shadow: var(--shadow-soft);
    }
    .add-spot-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .add-spot-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .add-spot-row input {
      border-radius: 999px;
      border: 1px solid #e5d1a8;
      padding: 7px 10px;
      font-size: 13px;
      flex: 1;
    }

    /* Images */
    .image-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .spot-photo {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }

    /* Editable */
    [contenteditable="true"] {
      outline: none;
    }
    [contenteditable="true"]:focus {
      box-shadow: 0 0 0 1px #ffcf7a;
      border-radius: 4px;
      background: #fff7e1;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px 10px 10px;
      background: #ffe7c4;
      display: flex;
      justify-content: flex-end;
      z-index: 5;
    }
    footer .btn {
      min-width: 90px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="tripTitle" contenteditable="true">Niji Trip 2026 ğŸŒˆ</h1>
    <p id="tripDesc1" contenteditable="true">
      æ±äº¬è¡Œç¨‹ï¼æš–è‰²ä¸»é¡Œï¼æ‹–æ‹‰æ’åºï¼‹ä½å®¿ï¼‹åœ–ç‰‡ï¼‹é›²ç«¯å‚™ä»½
    </p>
    <p id="tripDesc2" contenteditable="true">
      âœï¸ æ¯å¼µè¡Œç¨‹å¡å¯æ‹–æ‹‰æ’åºã€åŠ å…¥åœ–ç‰‡ã€é–‹å•Ÿåœ°åœ–é è¦½ã€‚è³‡æ–™æœƒè‡ªå‹•å„²å­˜ï¼Œä¹Ÿå¯ä»¥åŒ¯å‡º JSON ä¸Šå‚³é›²ç«¯ã€‚
    </p>
    <div class="header-row">
      <button class="btn" id="backupExportBtn">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
      <button class="btn" id="backupImportBtn">åŒ¯å…¥å‚™ä»½</button>
      <button class="btn primary" id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
      <button class="btn danger" id="removeLastDayBtn">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
    </div>
  </header>

  <div class="day-nav-wrap">
    <div class="day-nav-row" id="dayNavRow">
      <!-- ç”± JS å»ºç«‹ Day æ¨™ç±¤ -->
    </div>
  </div>

  <div class="page">
    <div id="content">
      <!-- ç”± JS å»ºç«‹ Day å€å¡Š -->
    </div>
  </div>

  <footer>
    <button class="btn" id="undoBtn">â†© å›ä¸Šä¸€æ­¥</button>
  </footer>

  <!-- éš±è— inputï¼šå‚™ä»½ï¼ç…§ç‰‡ -->
  <input type="file" id="backupImportFile" accept="application/json" style="display:none" />
  <input type="file" id="photoInput" accept="image/*" style="display:none" />

  <script>
    const STORAGE_KEY = "nijiTrip2026_v2";

    let undoStack = [];
    let currentPhotoTarget = null; // æŒ‡å‘è¦å¡åœ–ç‰‡çš„ .image-list

    // ===== åˆå§‹åŒ–é è¨­ Day =====
    function createInitialDays() {
      const startDate = new Date(2026, 4, 8); // 2026/05/08
      const total = 14;
      for (let i = 0; i < total; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        const id = "day-" + (i + 1);
        createDay(id, d);
      }
      recalcDayNumbers();
    }

    // å»ºç«‹å–®ä¸€å¤©ï¼ˆnav + å€å¡Šï¼‰
    function createDay(dayId, dateObj) {
      const navRow = document.getElementById("dayNavRow");
      const content = document.getElementById("content");

      const index = navRow.children.length + 1;

      // nav chip
      const chip = document.createElement("div");
      chip.className = "day-chip";
      chip.draggable = true;
      chip.dataset.dayId = dayId;

      const spanMain = document.createElement("span");
      spanMain.className = "day-chip-main";
      spanMain.contentEditable = "true";
      spanMain.textContent = "Day " + index;

      const spanSub = document.createElement("span");
      spanSub.className = "day-chip-sub";
      spanSub.contentEditable = "true";
      spanSub.textContent = formatDateShort(dateObj);

      chip.appendChild(spanMain);
      chip.appendChild(spanSub);
      navRow.appendChild(chip);

      // day section
      const sec = document.createElement("section");
      sec.className = "day-section";
      sec.dataset.dayId = dayId;
      sec.dataset.dateIso = dateObj.toISOString();

      const title = document.createElement("div");
      title.className = "day-title";
      title.innerHTML =
        '<span class="day-title-main" contenteditable="true">Day ' +
        index +
        '</span>ï¼ˆ<span class="day-title-date" contenteditable="true">' +
        formatDateShort(dateObj) +
        "</span>ï¼‰";
      sec.appendChild(title);

      const body = document.createElement("div");
      body.className = "day-body";

      // daily note block
      body.appendChild(createDailyNoteBlock());

      // add-spot card
      body.appendChild(createAddSpotBlock());

      sec.appendChild(body);
      content.appendChild(sec);
    }

    function formatDateShort(d) {
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return m + "/" + day;
    }

    // ===== å»ºç«‹å„ç¨®å¡ç‰‡ =====
    function createDailyNoteBlock() {
      const block = document.createElement("div");
      block.className = "day-block day-note-block";
      block.draggable = true;

      block.innerHTML = `
        <div class="day-note-header">
          <span class="day-note-title" contenteditable="true">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</span>
          <button class="btn small btn-daynote-photo">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="day-note-box" contenteditable="true">
ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦
        </div>
        <div class="image-list"></div>
      `;
      return block;
    }

    function createAddSpotBlock() {
      const block = document.createElement("div");
      block.className = "add-spot-card";
      block.innerHTML = `
        <div class="add-spot-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
        <div class="add-spot-row">
          <input type="text" class="input-spot-name-zh" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
          <input type="text" class="input-spot-name-ja" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        </div>
        <button class="btn primary btn-add-spot">æ–°å¢</button>
      `;
      return block;
    }

    function createSpotCard(zh, ja) {
      const block = document.createElement("div");
      block.className = "day-block spot-card";
      block.draggable = true;
      block.innerHTML = `
        <div class="spot-header">
          <div>
            <div class="spot-name-zh" contenteditable="true">${zh || "æ™¯é»åç¨±"}</div>
            <div class="spot-name-ja" contenteditable="true">${ja || "æ—¥æ–‡åç¨±æˆ–åœ°å€"}</div>
            <div class="spot-meta" contenteditable="true">åœ°å€ãƒ»ç°¡çŸ­èªªæ˜å¯å¯«åœ¨é€™è£¡</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn small btn-dir">å¾é£¯åº—å°èˆª</button>
          <button class="btn small btn-search">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
          <button class="btn small btn-map">åœ°åœ–é è¦½</button>
          <button class="btn small btn-photo">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="drag-hint">â‹®â‹® æ‹–æ‹‰æ•´å¼µå¡ç‰‡å¯ä»¥èª¿æ•´é †åº</div>
        <div class="image-list"></div>
      `;
      return block;
    }

    // ===== äº‹ä»¶ç¶å®š =====
    function attachCommonEvents(root = document) {
      // editable -> save
      root.querySelectorAll("[contenteditable='true']").forEach((el) => {
        el.removeEventListener("input", onEditableInput);
        el.addEventListener("input", onEditableInput);
      });

      attachDayNavDragEvents();
      attachDayBlocksDragEvents(root);
      attachSpotButtons(root);
      attachDayNotePhotoButtons(root);
      attachAddSpotButtons(root);
    }

    function onEditableInput() {
      scheduleSave();
    }

    // ---- Day nav æ‹–æ‹‰ ----
    function attachDayNavDragEvents() {
      const navRow = document.getElementById("dayNavRow");
      const chips = navRow.querySelectorAll(".day-chip");

      chips.forEach((chip) => {
        chip.removeEventListener("dragstart", onDayChipDragStart);
        chip.removeEventListener("dragend", onDayChipDragEnd);
        chip.addEventListener("dragstart", onDayChipDragStart);
        chip.addEventListener("dragend", onDayChipDragEnd);
      });

      navRow.removeEventListener("dragover", onDayNavDragOver);
      navRow.removeEventListener("drop", onDayNavDrop);
      navRow.addEventListener("dragover", onDayNavDragOver);
      navRow.addEventListener("drop", onDayNavDrop);
    }

    let draggingDayId = null;

    function onDayChipDragStart(e) {
      draggingDayId = e.currentTarget.dataset.dayId;
      e.currentTarget.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }
    function onDayChipDragEnd(e) {
      e.currentTarget.classList.remove("dragging");
      draggingDayId = null;
      recalcDayNumbers();
      scheduleSave();
    }
    function onDayNavDragOver(e) {
      e.preventDefault();
      const navRow = e.currentTarget;
      const afterElement = getDragAfterElement(navRow, e.clientX);
      const draggingEl = navRow.querySelector(".day-chip.dragging");
      if (!draggingEl) return;
      if (afterElement == null) {
        navRow.appendChild(draggingEl);
      } else {
        navRow.insertBefore(draggingEl, afterElement);
      }
    }
    function onDayNavDrop(e) {
      e.preventDefault();
      if (!draggingDayId) return;
      const order = Array.from(
        document.querySelectorAll(".day-chip")
      ).map((chip) => chip.dataset.dayId);
      const content = document.getElementById("content");
      const sections = Array.from(content.querySelectorAll(".day-section"));

      order.forEach((id) => {
        const sec = sections.find((s) => s.dataset.dayId === id);
        if (sec) content.appendChild(sec);
      });
      recalcDayNumbers();
      scheduleSave();
    }

    function getDragAfterElement(container, x) {
      const draggableElements = [
        ...container.querySelectorAll(".day-chip:not(.dragging)"),
      ];
      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = x - box.left - box.width / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY, element: null }
      ).element;
    }

    // ---- Day å…§éƒ¨å¡ç‰‡æ‹–æ‹‰ ----
    function attachDayBlocksDragEvents(root = document) {
      root.querySelectorAll(".day-block").forEach((blk) => {
        blk.removeEventListener("dragstart", onDayBlockDragStart);
        blk.removeEventListener("dragend", onDayBlockDragEnd);
        blk.addEventListener("dragstart", onDayBlockDragStart);
        blk.addEventListener("dragend", onDayBlockDragEnd);
      });

      root.querySelectorAll(".day-body").forEach((body) => {
        body.removeEventListener("dragover", onDayBodyDragOver);
        body.removeEventListener("drop", onDayBodyDrop);
        body.addEventListener("dragover", onDayBodyDragOver);
        body.addEventListener("drop", onDayBodyDrop);
      });
    }

    let draggingBlock = null;

    function onDayBlockDragStart(e) {
      draggingBlock = e.currentTarget;
      draggingBlock.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }

    function onDayBlockDragEnd() {
      if (draggingBlock) draggingBlock.classList.remove("dragging");
      draggingBlock = null;
      scheduleSave();
    }

    function onDayBodyDragOver(e) {
      e.preventDefault();
      if (!draggingBlock) return;
      const container = e.currentTarget;
      const afterElement = getDragAfterElementVertical(
        container,
        e.clientY
      );
      if (afterElement == null) {
        container.appendChild(draggingBlock);
      } else {
        container.insertBefore(draggingBlock, afterElement);
      }
    }

    function onDayBodyDrop(e) {
      e.preventDefault();
      scheduleSave();
    }

    function getDragAfterElementVertical(container, y) {
      const elements = [
        ...container.querySelectorAll(".day-block:not(.dragging)"),
      ];
      return elements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY, element: null }
      ).element;
    }

    // ---- Spot ç›¸é—œæŒ‰éˆ• ----
    function attachSpotButtons(root = document) {
      root.querySelectorAll(".btn-photo").forEach((btn) => {
        btn.onclick = () => {
          const card = btn.closest(".day-block");
          const list = card.querySelector(".image-list");
          currentPhotoTarget = list;
          const input = document.getElementById("photoInput");
          input.value = "";
          input.click();
        };
      });

      root.querySelectorAll(".btn-dir").forEach((btn) => {
        btn.onclick = () => openMap(btn, "hotel");
      });
      root.querySelectorAll(".btn-search").forEach((btn) => {
        btn.onclick = () => openMap(btn, "search");
      });
      root.querySelectorAll(".btn-map").forEach((btn) => {
        btn.onclick = () => openMap(btn, "place");
      });
    }

    function openMap(btn, mode) {
      const card = btn.closest(".day-block");
      const ja = card.querySelector(".spot-name-ja")?.textContent.trim();
      if (!ja) {
        alert("è«‹å…ˆå¡«å¯«æ—¥æ–‡åç¨±æˆ–åœ°å€");
        return;
      }
      let url = "https://www.google.com/maps/search/";
      if (mode === "hotel") {
        url += encodeURIComponent("é£¯åº— åˆ° " + ja);
      } else {
        url += encodeURIComponent(ja);
      }
      window.open(url, "_blank");
    }

    // ---- ç•¶æ—¥å‚™è¨»ç…§ç‰‡ ----
    function attachDayNotePhotoButtons(root = document) {
      root.querySelectorAll(".btn-daynote-photo").forEach((btn) => {
        btn.onclick = () => {
          const block = btn.closest(".day-block");
          const list = block.querySelector(".image-list");
          currentPhotoTarget = list;
          const input = document.getElementById("photoInput");
          input.value = "";
          input.click();
        };
      });
    }

    // ---- æ–°å¢ spot ----
    function attachAddSpotButtons(root = document) {
      root.querySelectorAll(".btn-add-spot").forEach((btn) => {
        btn.onclick = () => {
          const card = btn.closest(".add-spot-card");
          const body = card.closest(".day-body");
          const zh = card.querySelector(".input-spot-name-zh").value.trim();
          const ja = card.querySelector(".input-spot-name-ja").value.trim();
          const spot = createSpotCard(zh || "æ™¯é»åç¨±", ja || "æ—¥æ–‡åç¨±æˆ–åœ°å€");
          body.insertBefore(spot, card);
          card.querySelector(".input-spot-name-zh").value = "";
          card.querySelector(".input-spot-name-ja").value = "";
          attachCommonEvents(spot);
          scheduleSave();
        };
      });
    }

    // ---- ç…§ç‰‡ input change ----
    document.getElementById("photoInput").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file || !currentPhotoTarget) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const url = ev.target.result;
        const img = document.createElement("img");
        img.className = "spot-photo";
        img.src = url;
        img.alt = "ç…§ç‰‡";
        img.onclick = () => {
          if (confirm("è¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) {
            img.remove();
            scheduleSave();
          }
        };
        currentPhotoTarget.appendChild(img);
        scheduleSave();
      };
      reader.readAsDataURL(file);
    });

    // ===== Day ç·¨è™Ÿ & æ—¥æœŸ =====
    function recalcDayNumbers() {
      const chips = document.querySelectorAll(".day-chip");
      const sections = document.querySelectorAll(".day-section");

      chips.forEach((chip, idx) => {
        const id = chip.dataset.dayId;
        const num = idx + 1;
        const main = chip.querySelector(".day-chip-main");
        if (main && main.textContent.startsWith("Day")) {
          main.textContent = "Day " + num;
        }
        const sec = Array.from(sections).find(
          (s) => s.dataset.dayId === id
        );
        if (sec) {
          const titleMain = sec.querySelector(".day-title-main");
          if (titleMain && titleMain.textContent.startsWith("Day")) {
            titleMain.textContent = "Day " + num;
          }
        }
      });
    }

    function addNewDay() {
      const navRow = document.getElementById("dayNavRow");
      const lastChip = navRow.lastElementChild;
      let date = new Date();
      if (lastChip) {
        const lastId = lastChip.dataset.dayId;
        const sec = document.querySelector(
          '.day-section[data-day-id="' + lastId + '"]'
        );
        if (sec && sec.dataset.dateIso) {
          const d = new Date(sec.dataset.dateIso);
          d.setDate(d.getDate() + 1);
          date = d;
        }
      }
      const newId = "day-" + (navRow.children.length + 1);
      createDay(newId, date);
      attachCommonEvents();
      recalcDayNumbers();
      scheduleSave();
    }

    function removeLastDay() {
      const navRow = document.getElementById("dayNavRow");
      if (navRow.children.length <= 1) {
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©è¡Œç¨‹å–”ï¼");
        return;
      }
      const lastChip = navRow.lastElementChild;
      const id = lastChip.dataset.dayId;
      const sec = document.querySelector(
        '.day-section[data-day-id="' + id + '"]'
      );
      if (sec) sec.remove();
      lastChip.remove();
      recalcDayNumbers();
      scheduleSave();
    }

    // ===== å‚™ä»½ & è‡ªå‹•å„²å­˜ =====
    function getContentData() {
      return {
        headerHTML: document.querySelector("header").innerHTML,
        navHTML: document.getElementById("dayNavRow").innerHTML,
        contentHTML: document.getElementById("content").innerHTML,
      };
    }

    function setContentData(data) {
      document.querySelector("header").innerHTML = data.headerHTML;
      document.getElementById("dayNavRow").innerHTML = data.navHTML;
      document.getElementById("content").innerHTML = data.contentHTML;
      // é‡æ–°æ›äº‹ä»¶
      restoreHeaderButtons();
      attachCommonEvents();
      recalcDayNumbers();
    }

    function saveState(pushUndo = true) {
      const data = getContentData();
      const json = JSON.stringify(data);
      if (pushUndo) {
        undoStack.push(json);
        if (undoStack.length > 30) undoStack.shift();
      }
      localStorage.setItem(STORAGE_KEY, json);
    }

    let saveTimer = null;
    function scheduleSave() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveState(true), 500);
    }

    function restoreFromLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        setContentData(data);
        undoStack = [raw];
        return true;
      } catch (e) {
        console.error(e);
        return false;
      }
    }

    // åŒ¯å‡ºï¼åŒ¯å…¥
    function attachBackupButtons() {
      const exportBtn = document.getElementById("backupExportBtn");
      const importBtn = document.getElementById("backupImportBtn");
      const fileInput = document.getElementById("backupImportFile");

      if (exportBtn) {
        exportBtn.onclick = () => {
          const data = getContentData();
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "NijiTrip2026_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        };
      }

      if (importBtn) {
        importBtn.onclick = () => {
          fileInput.value = "";
          fileInput.click();
        };
      }

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            setContentData(data);
            const raw = JSON.stringify(data);
            undoStack = [raw];
            localStorage.setItem(STORAGE_KEY, raw);
          } catch (err) {
            alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    // header è£¡çš„æŒ‰éˆ•æœƒè¢« innerHTML é‡è¨­ï¼Œè¦é‡æ–°æŠ“ä¸€æ¬¡
    function restoreHeaderButtons() {
      document
        .getElementById("addDayBtn")
        ?.addEventListener("click", addNewDay);
      document
        .getElementById("removeLastDayBtn")
        ?.addEventListener("click", removeLastDay);
      document
        .getElementById("backupExportBtn")
        ?.addEventListener("click", () => {}); // ä¹‹å¾Œåœ¨ attachBackupButtons å†æ›
      document
        .getElementById("backupImportBtn")
        ?.addEventListener("click", () => {});
      attachBackupButtons();
      const undoBtn = document.getElementById("undoBtn");
      if (undoBtn) {
        undoBtn.onclick = () => {
          if (undoStack.length <= 1) return;
          undoStack.pop();
          const raw = undoStack[undoStack.length - 1];
          const data = JSON.parse(raw);
          setContentData(data);
          localStorage.setItem(STORAGE_KEY, raw);
        };
      }
    }

    // ===== å•Ÿå‹• =====
    document.addEventListener("DOMContentLoaded", () => {
      const restored = restoreFromLocal();
      if (!restored) {
        createInitialDays();
      }
      restoreHeaderButtons();
      attachCommonEvents();
      attachBackupButtons();
      saveState(false); // åˆå§‹åŒ–ä¸€ç­† undo
    });
  </script>
</body>
</html>
